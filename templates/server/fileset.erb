FileSet {
  Name = "<%= @fset_name %>"
  Ignore FileSet Changes = <%= @ignore_changes ? 'yes' : 'no' %>
  Include {
    Options {
        aclsupport = <%= @acl_support ? 'yes' : 'no' %>
        sparse = yes
        signature = MD5
        compression = GZIP
<% if @onefs -%>
        OneFS = yes
<% else -%>
        OneFS = no
<%   [@fstype].flatten.sort.each do |fs| -%>
        FSType = <%= fs %>
<%   end -%>
<% end -%>
    }
<% # Single element arrays become plain strings in PuppetDB
   incl = [@include_paths].flatten
   incl.each do |path| -%>
    File = <%= path %>
<% end -%>
<% unless @exclude_dir_containing.to_s == '' -%>
    Exclude dir containing = "<%= @exclude_dir_containing %>"
<% end -%>
  }
<% if not @exclude_paths.empty?
     excl = [@exclude_paths].flatten

     # If one of the include paths is "/", use full exclude list.
     # Otherwise filter out excludes which do not prefix match any of
     # the include paths.

     unless incl.include? '/'
       excl = excl.reject do |p|
         incl.select { |i| p =~ %r{^#{i}/} }.empty?
       end
     end
-%>
  Exclude {
<% excl.each do |path| -%>
    File = <%= path %>
<% end -%>
  }
<% end -%>
}
