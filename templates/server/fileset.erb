FileSet {
  Name = "<%= @fset_name %>"
  Ignore FileSet Changes = <%= @ignore_changes ? 'yes' : 'no' %>
  Include {
    Options {
        aclsupport = <%= @acl_support ? 'yes' : 'no' %>
        Sparse = yes
        Signature = MD5
<% if @compression -%>
        Compression = <%= @compression %>
<% end -%>
<% if @onefs -%>
        OneFS = yes
<% else -%>
        OneFS = no
<%   [@fstype].flatten.sort.each do |fs| -%>
        FSType = <%= fs %>
<%   end -%>
<% end -%>
    }
<% if not @exclude_patterns.empty? -%>
    Options {
<%   %w{wild_file wild_dir regex_file regex_dir}.each do |k|
       directive = k.split('_').map { |c| c.capitalize }.join('')
       if @exclude_patterns.include? k
         [@exclude_patterns[k]].flatten.each do |val| -%>
      <%= directive %> = <%= val.inspect %>
<%       end
       end
     end -%>
      Exclude = yes
    }
<% end -%>
<% # Single element arrays become plain strings in PuppetDB
   incl = [@include_paths].flatten
   incl.each do |path| -%>
    File = <%= path %>
<% end -%>
<% unless @exclude_dir_containing.to_s == '' -%>
    Exclude dir containing = "<%= @exclude_dir_containing %>"
<% end -%>
  }
<% if not @exclude_paths.empty?
     excl = [@exclude_paths].flatten

     # If one of the include paths is "/", use full exclude list.
     # Otherwise filter out excludes which do not prefix match any of
     # the include paths.

     unless incl.include? '/'
       excl = excl.reject do |p|
         incl.select { |i| p =~ %r{^#{i}/} }.empty?
       end
     end
-%>
  Exclude {
<% excl.each do |path| -%>
    File = <%= path %>
<% end -%>
  }
<% end -%>
}
